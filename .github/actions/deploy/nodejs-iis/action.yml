name: Action para desplegar aplicaciones Node.js en IIS
description: Esta acción se encarga de desplegar aplicaciones Node.js en un servidor IIS.
inputs:
  ########################################################################
  # Conexión al servidor
  ########################################################################
  server_ip:
    description: 'Dirección IP del servidor donde se desplegará la aplicación'
    required: true
  remote_user:
    description: 'Usuario para conectarse al servidor remoto'
    required: true
  ########################################################################
  # Tipo de despliegue
  ########################################################################
  tipo_despliegue:
    description: 'Tipo de despliegue a realizar'
    required: true
  ########################################################################
  # Configuración del sitio/webapp en IIS
  ########################################################################
  project_path:
    description: 'Ruta de la aplicación en el servidor'
    required: true
  site_name:
    description: 'Nombre del sitio en IIS'
    required: true
  webapp_name:
    description: 'Nombre de la web application en IIS (solo para tipo_deploy = webapp)'
    required: false
    default: ''
  ip_address:
    description: 'Dirección IP del sitio (dejar vacío para todas las IPs)'
    required: false
    default: '*'
  host_header:
    description: 'Header del host para el sitio'
    required: false
    default: 'localhost'
  port_site:
    description: 'Puerto del sitio'
    required: false
    default: '80'
  app_pool_name:
    description: 'Nombre del Application Pool'
    required: true
  ########################################################################
  # Configuración de la aplicación
  ########################################################################
  app_name:
    description: 'Nombre de la aplicación a desplegar'
    required: true
  start_command:
    description: 'Comando para iniciar la aplicación con PM2'
    required: true
  app_port:
    description: 'Puerto de la aplicación'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Desplegar aplicación en IIS
      run: |
        echo "Instalar dependencias npm..."
        ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} "cd C:\artifacts\nodejs\${{ inputs.app_name }} && npm install"
        echo "Eliminar proceso pm2..."
        ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} pm2 stop ${{ inputs.app_name }}
        ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} pm2 delete ${{ inputs.app_name }}
        # Revisar el paso de eliminar el directorio de la aplicación
        # echo "Eliminando directorio de la aplicación..."
        # ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} rmdir /s /q \"${{ inputs.project_path }}\${{ inputs.app_name }}\"
        echo "Desplegando aplicación en IIS..."
        ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} move \"C:\artifacts\nodejs\${{ inputs.app_name }}\" \"${{ inputs.project_path }}\"
      shell: cmd

    - name: Crear App Pool de IIS
      uses: ./orquestador/.github/actions/utils/application-pool/create-app-pool
      with:
        app_pool_name: '${{ inputs.app_name }}-app-pool'
        managed_runtime_version: 'v4.0'
        managed_pipeline_mode: 'Integrated'
        servidor_remoto: '${{ inputs.server_ip }}'
        usuario: '${{ inputs.remote_user }}'

    - name: Conceder permisos al directorio del proyecto
      run: |
        echo "Concediendo permisos al directorio del proyecto en el servidor remoto"
        ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} powershell -Command "icacls '${{ inputs.project_path }}\${{ inputs.app_name }}' /grant 'IIS_IUSRS:(OI)(CI)M'"
      shell: powershell

    - name: Crear Sitio en IIS
      if: ${{ inputs.tipo_despliegue == 'site' }}
      uses: ./orquestador/.github/actions/utils/iis-site/create-iis-site
      with:
        # Conexión al servidor
        servidor_remoto: '${{ inputs.server_ip }}'
        usuario: '${{ inputs.remote_user }}'
        # Configuración del sitio
        site_name: '${{ inputs.site_name }}'
        app_pool_name: '${{ inputs.app_name }}-app-pool'
        physical_path: '${{ inputs.project_path }}\${{ inputs.app_name }}'
        host_header: ${{ inputs.host_header }}
        port: ${{ inputs.port_site }}
        ip_address: '${{ inputs.ip_address }}'

    - name: Crear Web Application en IIS
      if: ${{ inputs.tipo_despliegue == 'webapp' }}
      uses: ./orquestador/.github/actions/utils/iis-webapp/create-iis-web-app
      with:
        # Conexión al servidor
        servidor_remoto: '${{ inputs.server_ip }}'
        usuario: '${{ inputs.remote_user }}'
        # Configuración del sitio
        site_name: '${{ inputs.site_name }}'
        app_name: '${{ inputs.webapp_name }}'
        app_pool_name: '${{ inputs.app_name }}-app-pool'
        physical_path: '${{ inputs.project_path }}\${{ inputs.app_name }}'
        

    - name: Iniciar aplicación con PM2
      run: |
        echo "Parametros:"
        echo "  - Nombre de la aplicación: ${{ inputs.app_name }}"
        echo "  - Ruta del proyecto: ${{ inputs.project_path }}\${{ inputs.app_name }}"
        echo "  - Comando de inicio: ${{ inputs.start_command }}"
        echo "  - Ruta completa: ${{ inputs.project_path }}\${{ inputs.app_name }}\${{ inputs.start_command }}"
        echo "Iniciando aplicación..."
        # Si la variable start_command es igual a "-", entonces iniciamos con pm2 serve
        if ("${{ inputs.start_command }}" -eq "-") {
          ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} "pm2 serve ${{ inputs.project_path }}\${{ inputs.app_name }}\build ${{ inputs.app_port }} --name ${{ inputs.app_name }}"
        } else {
          ssh ${{ inputs.remote_user }}@${{ inputs.server_ip }} "set PORT=${{ inputs.app_port }} && set NODE_PORT=${{ inputs.app_port }} && pm2 start ${{ inputs.project_path }}\${{ inputs.app_name }}\${{ inputs.start_command }} --name ${{ inputs.app_name }}"
        }
      shell: powershell

    - name: Configurar proxy inverso en IIS para Sitio
      if: ${{ inputs.tipo_despliegue == 'site' }}
      uses: ./orquestador/.github/actions/utils/iis-site/setup-reverse-proxy
      with:
        site_name: '${{ inputs.site_name }}'
        target_url: 'http://localhost:${{ inputs.app_port }}'
        servidor_remoto: '${{ inputs.server_ip }}'
        usuario: '${{ inputs.remote_user }}'

    - name: Configurar proxy inverso en IIS para Web Application
      if: ${{ inputs.tipo_despliegue == 'webapp' }}
      uses: ./orquestador/.github/actions/utils/iis-site/setup-reverse-proxy
      with:
        site_name: '${{ inputs.site_name }}/${{ inputs.webapp_name }}'
        target_url: 'http://localhost:${{ inputs.app_port }}'
        servidor_remoto: '${{ inputs.server_ip }}'
        usuario: '${{ inputs.remote_user }}'
