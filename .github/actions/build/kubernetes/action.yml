name: Action para buildear aplicaciones en Kubernetes AKS
description: Esta acción se encarga de buildear aplicaciones en un clúster de Kubernetes AKS.
outputs:
  app_name:
    description: Nombre de la imagen Docker
    value: ${{ steps.export.outputs.app_name }}
runs:
  using: "composite"
  steps:
    - name: Exportar nombre de la imagen
      id: export
      run: |
        echo "Exportando nombre de la imagen..."
        $app_name = (Get-Content -Path .\k8s\deployment.yaml | Select-String -Pattern "name:").Line.Split(':')[1].Trim()
        echo "app_name=$app_name" >> $env:GITHUB_OUTPUT
        echo "Nombre de la imagen: $app_name"
      shell: powershell
      working-directory: ./app

    - name: Buscar Dockerfile y buildear imagen Docker
      run: |
        echo "Buscando Dockerfile..."
        if (Test-Path -Path './Dockerfile') {
          echo "Dockerfile encontrado. Procediendo a construir la imagen Docker con el nombre ${{ steps.export.outputs.app_name }}..."
          docker build -t ${{ steps.export.outputs.app_name }} . --no-cache
        } else {
          echo "Dockerfile no encontrado. Abortando."
          exit 1
        }
      shell: powershell
      working-directory: ./app

    - name: Subir imagen a un Docker Hub
      run: |
        echo "Subiendo imagen Docker a Docker Hub..."
        $app_name = "${{ steps.export.outputs.app_name }}"
        $registry = "xatomen"
        $fullImageName = "$registry/$app_name"

        echo "Subiendo imagen Docker a Docker Hub..."
        echo "Registry: $registry"
        echo "Imagen: $fullImageName"
        
        # Push de la imagen al registry
        docker push $fullImageName
        
        if ($LASTEXITCODE -eq 0) {
            echo "Imagen subida exitosamente: $fullImageName"
        } else {
            echo "Error al subir la imagen al registry"
            exit 1
        }
      shell: powershell
      working-directory: ./app
